# 歷史記錄管理規格

## 新增的需求

### 需求：自動記錄轉換歷史
應自動記錄所有的轉換操作，包括輸入和輸出。

#### 情境：記錄轉換操作
- **當** 使用者成功執行提示詞轉換時
- **則** 應自動儲存到歷史記錄
- **且** 記錄應包含：
  - 唯一 ID（UUID）
  - 時間戳記
  - 原始輸入
  - 轉換結果
  - 使用的 API key ID
  - 使用的範本（如果有）
  - 執行時間（毫秒）
  - 狀態（成功/失敗）
- **且** 應儲存至 localStorage

#### 情境：記錄失敗操作
- **當** 轉換操作失敗時
- **則** 也應記錄到歷史
- **且** 應包含錯誤訊息
- **且** 應標記為失敗狀態
- **且** 失敗記錄不應計入統計

### 需求：歷史記錄 UI
應提供清晰的歷史記錄瀏覽介面。

#### 情境：開啟歷史記錄面板
- **當** 使用者點擊「歷史記錄」按鈕或按下 `Ctrl+H`
- **則** 應顯示歷史記錄側邊欄或彈出視窗
- **且** 應按時間倒序列出記錄（最新在上）
- **且** 每條記錄應顯示：
  - 時間（相對時間，如「2 小時前」）
  - 原始輸入（前 50 字元 + 省略號）
  - 轉換結果預覽（前 50 字元）
  - 狀態圖示（成功/失敗）
  - 使用的範本名稱（如果有）
- **且** 應支援無限捲動或分頁載入

#### 情境：檢視歷史記錄詳情
- **當** 使用者點擊某條歷史記錄
- **則** 應展開顯示完整內容
- **且** 應顯示：
  - 完整的原始輸入
  - 完整的轉換結果
  - 詳細的元資料（時間、執行時間、API key 等）
  - 使用的範本資訊
- **且** 應提供操作按鈕：
  - 「重新使用」- 將輸入填回主輸入區
  - 「複製結果」- 複製轉換結果
  - 「刪除」- 刪除此記錄
  - 「收藏」- 標記為收藏

### 需求：搜尋和篩選歷史
應提供強大的搜尋和篩選功能。

#### 情境：搜尋歷史記錄
- **當** 使用者在歷史面板輸入搜尋關鍵字
- **則** 應即時搜尋原始輸入和轉換結果
- **且** 應高亮顯示匹配的文字
- **且** 應顯示搜尋結果數量
- **且** 無結果時應顯示「無符合記錄」

#### 情境：按時間範圍篩選
- **當** 使用者選擇時間範圍篩選器
- **則** 應提供選項：
  - 今天
  - 最近 7 天
  - 最近 30 天
  - 自訂範圍（日期選擇器）
- **且** 應僅顯示該時間範圍內的記錄
- **且** 應顯示符合條件的記錄數量

#### 情境：按狀態篩選
- **當** 使用者選擇狀態篩選器
- **則** 應提供選項：
  - 全部
  - 僅成功
  - 僅失敗
- **且** 應即時更新顯示的記錄

#### 情境：按範本篩選
- **當** 使用者選擇範本篩選器
- **則** 應列出所有曾使用過的範本
- **且** 選擇後應顯示使用該範本的所有記錄
- **且** 應支援多選範本（OR 邏輯）

### 需求：收藏和標籤
應支援收藏重要的轉換記錄並添加標籤。

#### 情境：收藏記錄
- **當** 使用者點擊記錄的「收藏」按鈕
- **則** 應標記該記錄為已收藏
- **且** 應顯示收藏圖示（星星）
- **且** 應更新到 localStorage
- **且** 再次點擊應取消收藏

#### 情境：檢視收藏記錄
- **當** 使用者點擊「僅顯示收藏」篩選器
- **則** 應僅顯示已收藏的記錄
- **且** 應在頂部顯示收藏數量

#### 情境：添加標籤
- **當** 使用者點擊記錄的「添加標籤」按鈕
- **則** 應顯示標籤輸入框
- **且** 應支援自動完成（已有標籤）
- **且** 應支援多個標籤（逗號分隔）
- **且** 標籤應儲存到記錄中
- **且** 應顯示標籤徽章

#### 情境：按標籤篩選
- **當** 使用者點擊某個標籤徽章
- **則** 應篩選顯示包含該標籤的所有記錄
- **且** 應支援多個標籤篩選（OR 邏輯）

### 需求：歷史記錄統計
應提供歷史記錄的統計分析。

#### 情境：顯示統計儀表板
- **當** 使用者點擊「統計」標籤
- **則** 應顯示統計資訊：
  - 總轉換次數
  - 成功/失敗比例
  - 平均執行時間
  - 最常使用的範本（Top 5）
  - 使用趨勢圖（折線圖，最近 30 天）
  - 每日使用分佈（柱狀圖）
- **且** 統計應可選擇時間範圍
- **且** 應支援匯出統計報告

#### 情境：檢視時間趨勢
- **當** 顯示使用趨勢圖時
- **則** 應顯示折線圖
- **且** X 軸：日期
- **且** Y 軸：轉換次數
- **且** 懸停時應顯示詳細數據
- **且** 應區分成功和失敗

### 需求：歷史記錄管理
應提供批量管理和清理功能。

#### 情境：刪除單條記錄
- **當** 使用者點擊記錄的「刪除」按鈕
- **則** 應顯示確認對話框
- **且** 確認後應從歷史中移除
- **且** 應更新 localStorage
- **且** 應更新 UI

#### 情境：批量刪除
- **當** 使用者選擇多條記錄並點擊「批量刪除」
- **則** 應顯示確認對話框（顯示選擇數量）
- **且** 確認後應刪除所有選定記錄
- **且** 應更新統計資訊

#### 情境：清除歷史記錄
- **當** 使用者點擊「清除所有歷史」按鈕
- **則** 應顯示嚴重警告對話框
- **且** 應要求輸入確認文字（例如：「DELETE」）
- **且** 確認後應刪除所有記錄
- **且** 應保留收藏的記錄（詢問是否一併刪除）
- **且** 應重置統計資訊

#### 情境：自動清理舊記錄
- **當** 歷史記錄超過設定的數量限制（例如：1000 條）
- **則** 應自動刪除最舊的記錄
- **且** 應保留收藏的記錄
- **且** 應在設定中允許配置保留數量
- **且** 應提示使用者自動清理已執行

### 需求：匯出歷史記錄
應支援將歷史記錄匯出為多種格式。

#### 情境：匯出為 JSON
- **當** 使用者點擊「匯出」→「JSON 格式」
- **則** 應將選定的記錄匯出為 JSON 檔案
- **且** 檔名應包含時間戳記
- **且** 應包含完整的記錄資料
- **且** 格式應易於程式讀取

#### 情境：匯出為 CSV
- **當** 使用者點擊「匯出」→「CSV 格式」
- **則** 應將記錄匯出為 CSV 檔案
- **且** 應包含欄位：時間、輸入、輸出、範本、狀態
- **且** 應正確處理換行和特殊字元
- **且** 可在 Excel 中開啟

#### 情境：匯出為 Markdown
- **當** 使用者點擊「匯出」→「Markdown 格式」
- **則** 應將記錄匯出為 Markdown 檔案
- **且** 應使用清晰的標題和格式
- **且** 應包含目錄
- **且** 應易於閱讀和分享

### 需求：匯入歷史記錄
應支援從匯出的檔案匯入歷史記錄。

#### 情境：匯入 JSON 檔案
- **當** 使用者點擊「匯入」並選擇 JSON 檔案
- **則** 應驗證檔案格式
- **且** 應檢查記錄 ID 衝突
- **且** 衝突時應提示選擇：
  - 覆蓋現有記錄
  - 保留兩者（生成新 ID）
  - 跳過匯入
- **且** 匯入成功後應更新 UI 和統計

### 需求：歷史記錄同步（進階功能，可選）
支援跨裝置同步歷史記錄。

#### 情境：啟用雲端同步
- **當** 使用者啟用雲端同步功能
- **則** 應要求登入帳號
- **且** 應上傳本地歷史到雲端
- **且** 應從雲端下載其他裝置的歷史
- **且** 應合併衝突的記錄
- **且** 應加密敏感資料

#### 情境：自動同步
- **當** 執行轉換操作後
- **則** 應自動上傳到雲端（如果已啟用）
- **且** 應在背景執行（不阻塞 UI）
- **且** 失敗時應重試（最多 3 次）
- **且** 應顯示同步狀態圖示

### 需求：歷史記錄隱私
應保護使用者的歷史記錄隱私。

#### 情境：加密敏感內容
- **當** 儲存歷史記錄時
- **則** 應提供選項加密內容
- **且** 應使用使用者密碼派生金鑰
- **且** 加密後無法在 localStorage 中直接讀取
- **且** 開啟應用時應要求輸入密碼解密

#### 情境：無痕模式
- **當** 使用者啟用「無痕模式」
- **則** 應停止記錄歷史
- **且** 應在 UI 上顯示無痕模式圖示
- **且** 應提示「歷史記錄未啟用」
- **且** 關閉無痕模式後應恢復記錄

### 需求：快速存取
應提供快速存取最近記錄的方式。

#### 情境：快速重用最近輸入
- **當** 使用者按下 `↑` 鍵（在輸入框）
- **則** 應循環顯示最近的輸入
- **且** 應最多顯示最近 10 筆
- **且** 按 `↓` 鍵應反向循環
- **且** 應跳過失敗的記錄

#### 情境：顯示最近記錄快捷列
- **當** 使用者開啟應用時
- **則** 應在側邊顯示最近 5 筆記錄
- **且** 點擊應快速填入輸入區
- **且** 懸停應顯示完整預覽
- **且** 應可在設定中隱藏此功能

### 需求：歷史記錄備份
應提供自動備份功能。

#### 情境：自動備份
- **當** 歷史記錄數量達到設定閾值（例如：每 100 條）
- **則** 應自動匯出備份到下載資料夾
- **且** 備份檔名應包含時間戳記
- **且** 應保留最近 5 個備份
- **且** 應可在設定中配置

#### 情境：手動備份
- **當** 使用者點擊「備份歷史」按鈕
- **則** 應立即匯出完整歷史
- **且** 應包含所有收藏和標籤
- **且** 應顯示備份成功訊息

### 需求：效能優化
歷史記錄應不影響應用效能。

#### 情境：延遲載入
- **當** 開啟歷史面板時
- **則** 應先載入最近 50 筆記錄
- **且** 捲動到底部時應載入更多
- **且** 應使用虛擬捲動（大量記錄時）
- **且** 載入時應顯示載入指示器

#### 情境：索引建立
- **當** 搜尋或篩選歷史時
- **則** 應使用索引加速查詢
- **且** 應在儲存時建立索引
- **且** 索引應包含：時間、範本 ID、標籤
- **且** 大量資料時應使用 Web Worker
