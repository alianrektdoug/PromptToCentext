# API 整合規格

## 新增的需求

### 需求：Gemini API 客戶端
應實作一個封裝 Gemini API 的客戶端類別，處理所有 API 通訊。

#### 情境：初始化 Gemini 客戶端
- **當** 應用程式啟動時
- **則** 應建立 GeminiClient 實例
- **且** 應從 API Manager 取得可用的 API keys
- **且** 應初始化 key 輪替機制
- **且** 應設定預設的 API 參數（model、temperature 等）

#### 情境：發送轉換請求
- **當** 使用者觸發轉換操作
- **則** 應使用目前 API key 呼叫 Gemini API
- **且** 應包含系統提示詞指導 Gemini 如何轉換
- **且** 應包含使用者輸入的問題
- **且** 應設定合理的 timeout（例如：30 秒）
- **且** 應處理 API 回應並提取轉換後的文字

### 需求：API Key 管理器
應實作一個管理多組 API keys 的管理器，支援儲存、驗證和輪替。

#### 情境：儲存 API Keys
- **當** 使用者新增或編輯 API key
- **則** 應將 keys 加密後儲存至 localStorage
- **且** 應驗證 key 格式（以 `AIza` 開頭，長度 39 字元）
- **且** 應支援最多 5 組 keys
- **且** 應記錄每個 key 的狀態（啟用/停用/錯誤）

#### 情境：讀取 API Keys
- **當** 應用程式啟動時
- **則** 應從 localStorage 讀取儲存的 keys
- **且** 應解密 keys
- **且** 應驗證 keys 是否仍然有效
- **且** 如果沒有任何 key，應提示使用者設定

#### 情境：API Key 輪替
- **當** 進行 API 呼叫時
- **則** 應使用輪替策略選擇下一個可用的 key
- **且** 如果目前 key 回應 rate limit 錯誤，應自動切換到下一個 key
- **且** 應記錄每個 key 的使用統計（呼叫次數、錯誤次數）
- **且** 如果所有 keys 都無法使用，應回報錯誤

### 需求：錯誤處理與重試
API 呼叫應有完善的錯誤處理和重試機制。

#### 情境：處理網路錯誤
- **當** API 呼叫因網路問題失敗
- **則** 應自動重試最多 3 次
- **且** 應使用指數退避策略（1s, 2s, 4s）
- **且** 如果仍然失敗，應回報網路錯誤
- **且** 應記錄錯誤日誌

#### 情境：處理 API Key 無效
- **當** API 回應 401 或 403 錯誤
- **則** 應標記目前 key 為無效
- **且** 應自動切換到下一個可用 key
- **且** 應通知使用者該 key 有問題
- **且** 應建議使用者更新或移除該 key

#### 情境：處理 Rate Limit
- **當** API 回應 429 錯誤（rate limit）
- **則** 應立即切換到下一個可用 key
- **且** 應記錄被限制的 key 及時間
- **且** 應在一段時間後（例如：5 分鐘）重新啟用該 key
- **且** 如果所有 keys 都被限制，應提示使用者稍後再試

### 需求：系統提示詞配置
應提供可配置的系統提示詞，指導 Gemini 如何轉換使用者問題。

#### 情境：載入系統提示詞
- **當** 初始化 Gemini 客戶端時
- **則** 應載入預設的系統提示詞範本
- **且** 系統提示詞應包含：
  - 角色定義（你是專業提示詞優化專家）
  - 任務說明（將簡單問題轉換為專業上下文提示詞）
  - 輸出格式要求（Markdown 格式，包含背景、目標、約束等）
  - 範例（輸入輸出範例）
- **且** 應支援自訂提示詞（進階功能）

### 需求：API 回應驗證
應驗證 Gemini API 的回應格式和內容。

#### 情境：驗證 API 回應
- **當** 收到 Gemini API 回應時
- **則** 應檢查回應狀態碼
- **且** 應驗證回應 JSON 結構是否正確
- **且** 應提取文字內容並檢查是否為空
- **且** 如果回應格式異常，應回報錯誤
- **且** 應記錄原始回應以供除錯

### 需求：請求限流
應實作客戶端限流機制，避免過度呼叫 API。

#### 情境：限制請求頻率
- **當** 使用者連續觸發多次轉換
- **則** 應限制每分鐘最多 10 次請求
- **且** 超過限制時應顯示冷卻時間
- **且** 應在 UI 上顯示剩餘可用次數
- **且** 計數器應每分鐘重置

### 需求：離線偵測
應偵測網路狀態並在離線時提供友善提示。

#### 情境：偵測離線狀態
- **當** 使用者網路斷線
- **則** 應在 UI 上顯示離線提示
- **且** 應禁用「轉換」按鈕
- **且** 應提示使用者檢查網路連線
- **且** 當網路恢復時應自動更新狀態
